function ie(e,t){return e.syntaxTreeRoot.getLatex(e,t)}function L(e){return e.toLowerCase()!=e.toUpperCase()}function ee(e){if(e.length==0)return!1;if(L(e[e.length-1]))for(let t=e.length-2;t>=0;t--){let r=e[t];if(!L(r))return r=="\\"}return!1}function R(...e){let t="";for(let r=0;r<e.length;r++){let o=e[r];ee(t)&&L(o[0])&&(t+=" "),t+=o}return t}var c=class{constructor(){this.parentNode=null;this.nodes=[]}getLatex(t,r){let o=()=>R(...this.nodes.map(n=>n.getLatex(t,r)));return t.inclusiveSelectionLeftBorder===this?R(r.selectionHightlightStart,o()):this===t.current?this.nodes.length==0?r.activePlaceholderLatex:R(r.activePlaceholderLatex,o()):this.nodes.length==0?r.passivePlaceholderLatex:o()}};var B=class{constructor(){this.syntaxTreeRoot=new c;this.current=this.syntaxTreeRoot;this.selectionDiff=null;this.inclusiveSelectionRightBorder=null;this.inclusiveSelectionLeftBorder=null}};var le=new B;function ce(e,t){return(e instanceof B?e.syntaxTreeRoot:e).getLatex(le,t)}function re(e,t){let r=!1;for(let o=e.length-1;o>=0;o--){let n=e[o];if(!r){n===t&&(r=!0);continue}if(n.nodes.length>0)return n}return null}function b(e){return e.length==0?null:e[e.length-1]}function h(e,t){let r=e.indexOf(t);return r>0?e[r-1]:null}function M(e,t){let r=e.indexOf(t);e.splice(r,1)}var g=class{getLatex(t,r){let o=this.getLatexPart(t,r);return t.selectionDiff!=null&&t.selectionDiff!=0?(t.inclusiveSelectionLeftBorder===this&&(o=R(r.selectionHightlightStart,o)),t.inclusiveSelectionRightBorder===this&&(o=R(o,r.selectionHightlightEnd)),o):t.current===this?R(o,r.activePlaceholderLatex):o}};var f=class extends g{constructor(r){super();this.placeholders=r,this.placeholders.forEach(o=>{o.parentNode=this})}getMoveDownSuggestion(r){return null}getMoveUpSuggestion(r){return null}};function P(e){return e[e.length-1]}var A=class extends g{};var y=class extends A{};function Q(e,t,r){for(let o=e-1;o>=0;o--){let n=t[o];if(n instanceof y)M(t,n),r.nodes.unshift(n),n.parentPlaceholder=r;else break}}function E(e){let t=e.parentNode,r=t.parentPlaceholder.nodes.indexOf(t);t.parentPlaceholder.nodes.splice(r,1,...e.nodes);for(let o of e.nodes)o.parentPlaceholder=t.parentPlaceholder}function te(e){var t;if(e.current instanceof c){if(e.current.parentNode==null||e.current.nodes.length>0)return;{let r=re(e.current.parentNode.placeholders,e.current);if(r)e.current.parentNode.placeholders.length==2&&e.current===e.current.parentNode.placeholders[1]&&e.current.nodes.length==0?(E(r),e.current=P(r.nodes)):(r.nodes.pop(),e.current=(t=b(r.nodes))!=null?t:r);else if(e.current.parentNode.placeholders.every(o=>o.nodes.length==0)){let o=e.current.parentNode.parentPlaceholder,n=h(o.nodes,e.current.parentNode);M(o.nodes,e.current.parentNode),e.current=n!=null?n:o}else if(e.current.parentNode.placeholders[0]===e.current&&e.current.nodes.length==0&&e.current.parentNode.placeholders.some(o=>o.nodes.length!=0)){let o=h(e.current.parentNode.parentPlaceholder.nodes,e.current.parentNode);if(o!=null)se(o,e.current),e.current=P(e.current.nodes);else{let n=e.current.parentNode.placeholders.filter(i=>i.nodes.length!=0);if(n.length==1){let i=n[0].nodes,l=e.current.parentNode.parentPlaceholder,m=l.nodes.indexOf(e.current.parentNode);for(let S of i)S.parentPlaceholder=l;l.nodes.splice(m,1,...i),e.current=P(i)}}}}}else if(e.current instanceof f&&e.current.placeholders[0].nodes.length>0&&e.current.placeholders.slice(1).every(r=>r.nodes.length==0)){let r=e.current.placeholders[0];E(r),e.current=P(r.nodes)}else if(e.current instanceof f&&e.current.placeholders.some(r=>r.nodes.length>0))e.current=P(e.current.placeholders.flatMap(r=>r.nodes)),te(e);else{let r=h(e.current.parentPlaceholder.nodes,e.current);M(e.current.parentPlaceholder.nodes,e.current),e.current=r!=null?r:e.current.parentPlaceholder}}function se(e,t){M(t.parentNode.parentPlaceholder.nodes,e),t.nodes.push(e);let r=e.parentPlaceholder;e.parentPlaceholder=t,e instanceof y&&Q(r.nodes.length-1,r.nodes,t)}function D(e,t){let r=e.indexOf(t);return r!=-1&&r<e.length-1?e[r+1]:null}function X(e){var t;if(e.current instanceof c)if(e.current.parentNode!=null&&e.current.parentNode.placeholders.every(r=>r.nodes.length==0)){let r=h(e.current.parentNode.parentPlaceholder.nodes,e.current.parentNode);M(e.current.parentNode.parentPlaceholder.nodes,e.current.parentNode),e.current=r!=null?r:e.current.parentNode.parentPlaceholder}else{let r=e.current.nodes;if(r.length>0)oe(e,r[0]);else if(e.current.parentNode!=null){let o=e.current.parentNode,n=o.placeholders;if(n[0]==e.current&&n.length==2){let i=n[1];e.current=(t=h(o.parentPlaceholder.nodes,o))!=null?t:o.parentPlaceholder,E(i)}else for(let i=n.indexOf(e.current)+1;i<n.length;i++)if(n[i].nodes.length>0){e.current=n[i],X(e);return}}}else{let r=D(e.current.parentPlaceholder.nodes,e.current);r!=null&&oe(e,r)}}function oe(e,t){t instanceof f?t.placeholders.length==1&&t.placeholders[0].nodes.length>0?E(t.placeholders[0]):t.placeholders.length==2&&t.placeholders[0].nodes.length==0&&t.placeholders[1].nodes.length>0?E(t.placeholders[1]):(e.current=t.placeholders[0],X(e)):M(t.parentPlaceholder.nodes,t)}function q(e){e.selectionDiff=null,e.inclusiveSelectionRightBorder=null,e.inclusiveSelectionLeftBorder=null}function _(e){var r;if(e.selectionDiff==null)throw"Enter selection mode before calling this method.";if(e.selectionDiff==0)return q(e),[];let t=e.selectionDiff;if(e.current instanceof c)return q(e),e.current.nodes.splice(0,t);{let o=e.current.parentPlaceholder.nodes,n=o.indexOf(e.inclusiveSelectionLeftBorder);return e.current=(r=h(o,e.inclusiveSelectionLeftBorder))!=null?r:e.current.parentPlaceholder,q(e),o.splice(n,ae(t))}}function ae(e){return e<0?-e:e}function de(e){_(e)}function N(e){var t;if(e.current instanceof c)if(e.current.nodes.length>0){let r=e.current.nodes[0];e.current=r instanceof f?r.placeholders[0]:r}else{if(e.current.parentNode==null)return;e.current=(t=D(e.current.parentNode.placeholders,e.current))!=null?t:e.current.parentNode}else{let r=D(e.current.parentPlaceholder.nodes,e.current);if(r!=null)e.current=r instanceof f?r.placeholders[0]:r;else{let o=e.current.parentPlaceholder.parentNode;if(o!=null){let n=D(o.placeholders,e.current.parentPlaceholder);e.current=n!=null?n:o}}}}function a(e,t){if(t instanceof Array)for(let r of t)a(e,r),e.current=r;else{if(e.current instanceof c)e.current.nodes.unshift(t),t.parentPlaceholder=e.current;else{let r=e.current.parentPlaceholder,o=r.nodes.indexOf(e.current);r.nodes.splice(o+1,0,t),t.parentPlaceholder=r}N(e)}}var v=class extends f{constructor(r,o,...n){let i=n.length+1,l=new Array;for(let m=0;m<i;m++)l.push(new c);super(l);this.before=r,this.then=o,this.rest=n}getLatexPart(r,o){let n=this.before+this.placeholders[0].getLatex(r,o)+this.then;for(let i=0;i<this.rest.length;i++)n+=this.placeholders[i+1].getLatex(r,o)+this.rest[i];return n}};var I=class extends v{constructor(t=String.raw`\left(`,r=String.raw`\right)`){super(t,r)}};function $(e,t){for(let r of e)r.parentPlaceholder=t,t.nodes.push(r)}function F(e,t,r){var n;let o=t.placeholders[0];if(e.current instanceof g){let i=e.current.parentPlaceholder.nodes,l=i.indexOf(e.current);i[l]=t,t.parentPlaceholder=e.current.parentPlaceholder,e.current instanceof I&&(r!=null&&r.deleteOuterRoundBracketsIfAny)?($(e.current.placeholders[0].nodes,o),e.current=(n=D(t.placeholders,o))!=null?n:t):e.current instanceof y?(o.nodes.push(e.current),e.current.parentPlaceholder=o,Q(l,i,o),N(e)):(o.nodes.push(e.current),e.current.parentPlaceholder=o,N(e))}else a(e,t)}function pe(e,t){let r=_(e);if(a(e,t),r.length>0){let o=t.placeholders[0];$(r,o),e.current=P(r),N(e)}}function fe(e,t){var n;if(t.placeholders.length<2)throw"Expected 2 placeholders.";let r=_(e),o=t.placeholders[1];$(r,o),F(e,t),e.current=(n=b(r))!=null?n:o}function me(e){var o;let t=e.current instanceof c?e.current:e.current.parentPlaceholder,r;for(;;){if(t.parentNode==null)return;r=t.parentNode;let n=r.getMoveDownSuggestion(t);if(n!=null){e.current=(o=b(n.nodes))!=null?o:n;return}t=r.parentPlaceholder}}function ue(e){var t,r,o;if(e.current instanceof c){if(e.current.parentNode==null)return;let n=h(e.current.parentNode.placeholders,e.current);if(n!==null)e.current=(t=b(n.nodes))!=null?t:n;else{let i=e.current.parentNode.parentPlaceholder,l=h(i.nodes,e.current.parentNode);e.current=l!=null?l:i}}else if(e.current instanceof f){let n=P(e.current.placeholders);e.current=(r=b(n.nodes))!=null?r:n}else e.current=(o=h(e.current.parentPlaceholder.nodes,e.current))!=null?o:e.current.parentPlaceholder}function he(e){var o;let t=e.current instanceof c?e.current:e.current.parentPlaceholder,r;for(;;){if(t.parentNode==null)return;r=t.parentNode;let n=r.getMoveUpSuggestion(t);if(n!=null){e.current=(o=b(n.nodes))!=null?o:n;return}t=r.parentPlaceholder}}function C(e,t){if(e.selectionDiff=t,t==0)e.inclusiveSelectionLeftBorder=null,e.inclusiveSelectionRightBorder=null;else if(e.current instanceof c)e.inclusiveSelectionLeftBorder=e.current,e.inclusiveSelectionRightBorder=e.current.nodes[t-1];else{let r=e.current.parentPlaceholder.nodes,o=r.indexOf(e.current);if(t>0)e.inclusiveSelectionLeftBorder=r[o+1],e.inclusiveSelectionRightBorder=r[o+t];else{let n=o+t+1;if(n<0)throw"The TreeNode at index 0 of the current Placeholder is as far as you can go left if current is a TreeNode.";e.inclusiveSelectionLeftBorder=r[n],e.inclusiveSelectionRightBorder=e.current}}}function ge(e){C(e,0)}function xe(e){return e.selectionDiff!=null}function Pe(e){var r;let t=(r=e.selectionDiff)!=null?r:0;e.current instanceof g&&e.current.parentPlaceholder.nodes.indexOf(e.current)+t>=0||e.current instanceof c&&t>0?C(e,t-1):e.inclusiveSelectionLeftBorder instanceof g&&e.inclusiveSelectionLeftBorder.parentPlaceholder.nodes.indexOf(e.inclusiveSelectionLeftBorder)==0&&e.inclusiveSelectionLeftBorder.parentPlaceholder.parentNode!=null&&(e.current=e.inclusiveSelectionLeftBorder.parentPlaceholder.parentNode,C(e,-1))}function ye(e){var r,o;let t=(r=e.selectionDiff)!=null?r:0;if(e.current instanceof c&&t<e.current.nodes.length||e.current instanceof g&&e.current.parentPlaceholder.nodes.indexOf(e.current)+t<e.current.parentPlaceholder.nodes.length-1)C(e,t+1);else if(e.inclusiveSelectionRightBorder instanceof g&&P(e.inclusiveSelectionRightBorder.parentPlaceholder.nodes)==e.inclusiveSelectionRightBorder&&e.inclusiveSelectionRightBorder.parentPlaceholder.parentNode!=null){let n=e.inclusiveSelectionRightBorder.parentPlaceholder.parentNode;e.current=(o=h(n.parentPlaceholder.nodes,n))!=null?o:n.parentPlaceholder,C(e,1)}}var V=class{constructor(){this.additionalDigits=null;this.decimalSeparatorMatchers=[".","{,}"];this.preferRoundBracketsNode=!0}};var U=class extends v{getMoveDownSuggestion(t){let r=this.placeholders.indexOf(t);return r>0?this.placeholders[r-1]:null}getMoveUpSuggestion(t){let r=this.placeholders.indexOf(t);return r<this.placeholders.length-1?this.placeholders[r+1]:null}};var z=class extends y{constructor(r="."){super();this.latex=typeof r=="string"?()=>r:r}getLatexPart(r,o){return this.latex()}};var H=class extends v{getMoveDownSuggestion(t){let r=this.placeholders.indexOf(t);return r<this.placeholders.length-1?this.placeholders[r+1]:null}getMoveUpSuggestion(t){let r=this.placeholders.indexOf(t);return r>0?this.placeholders[r-1]:null}};var G=class extends y{constructor(r){super();this.latex=r}getLatexPart(r,o){return this.latex}};var T=class extends A{constructor(r){super();this.latex=typeof r=="string"?()=>r:r}getLatexPart(r,o){return this.latex()}};function w(e,t,r){let o=e.slice(-1),n=r.slice(e.length),i=0;for(let l=0;l<n.length;l++){if(n.substring(l,l+t.length)==t){if(i==0)return{content:n.slice(0,l),rest:n.slice(l+t.length)};i--;continue}let m=["\\"+o,"\\"+t,String.raw`\left`+o,String.raw`\right`+t],S=n.slice(l);for(let s of m)if(S.length>=s.length&&S.startsWith(s)){l+=s.length;continue}n[l]==o&&i++}throw`A closing ${t} is missing.`}var J=class extends f{constructor(r,o,n){let i=[],l=[];for(let m=0;m<n;m++){let S=[];for(let s=0;s<o;s++){let u=new c;S.push(u),l.push(u)}i.push(S)}super(l);this.grid=i,this.matrixType=r,this.width=o}getLatexPart(r,o){let n=String.raw`\begin{${this.matrixType}}`;return n+=this.grid.map(i=>i.map(l=>l.getLatex(r,o)).join(" & ")).join(String.raw` \\ `),n+=String.raw`\end{${this.matrixType}}`,n}getMoveDownSuggestion(r){let{rowIndex:o,columnIndex:n}=this.getPositionOf(r);return o+1<this.grid.length?this.grid[o+1][n]:null}getMoveUpSuggestion(r){let{rowIndex:o,columnIndex:n}=this.getPositionOf(r);return o-1>=0?this.grid[o-1][n]:null}getPositionOf(r){let o=this.placeholders.indexOf(r);if(o==-1)throw"The provided Placeholder is not part of this MatrixNode.";let n=Math.floor(o/this.width),i=o-n*this.width;return{rowIndex:n,columnIndex:i}}};function W(e,t=new V){var n,i;if(e==null)return new B;let r=e.trim(),o=new B;for(;r!="";){if(r[0]==" "){r=r.trimStart();continue}let l=t.decimalSeparatorMatchers.find(s=>r.startsWith(s));if(l!=null){a(o,new z((n=t.preferredDecimalSeparator)!=null?n:l)),r=r.slice(l.length);continue}if(["1","2","3","4","5","6","7","8","9","0"].includes(r[0])||(i=t.additionalDigits)!=null&&i.includes(r[0])){a(o,new G(r[0])),r=r.slice(1);continue}let m=!1;if(r.startsWith(String.raw`\begin{`)){let s=w(String.raw`\begin{`,"}",r);if(!s.content.endsWith("matrix")&&!s.content.endsWith("cases"))throw String.raw`Expected a word ending with 'matrix' or 'cases' after '\begin{'.`;let d=s.rest.slice(0,s.rest.indexOf(String.raw`\end{${s.content}}`)).split(String.raw`\\`);a(o,new J(s.content,d[0].split("&").length,d.length));for(let x of d)for(let O of x.split("&")){let K=W(O,t).syntaxTreeRoot.nodes;a(o,K),N(o)}let p=String.raw`\end{${s.content}}`;r=r.slice(r.indexOf(p)+p.length);continue}if(t.preferRoundBracketsNode&&(r[0]=="("||r.startsWith(String.raw`\left(`))){let s=r[0]=="("?"(":String.raw`\left(`,u=r[0]=="("?")":String.raw`\right)`,d=new I(s,u);a(o,d);let p=w(s,u,r),x=W(p.content,t).syntaxTreeRoot.nodes;a(o,x),o.current=d,r=p.rest;continue}if(r.startsWith("\\")){for(let d of["\\left\\","\\right\\",String.raw`\left`,String.raw`\right`])if(r.startsWith(d)&&!L(r.slice(d.length)[0])){a(o,new T(d+r[d.length])),r=r.slice(d.length+1),m=!0;break}if(m)continue;let s=String.raw`\text{`;if(r.startsWith(s)){let d=w(s,"}",r),p=new v(s,"}");a(o,p);for(let x of d.content)a(o,new T(x));o.current=p,r=d.rest;continue}let u="\\";if(L(r[1])){for(let d=1;d<r.length;d++){let p=r[d];if(L(p))u+=p;else if(p=="{"||p=="["){let x=u+p,O=p=="{"?"}":"]",K=w(x,O,r),Z=W(K.content,t).syntaxTreeRoot.nodes;if(K.rest[0]=="{"){let j=new H(x,O+"{","}");a(o,j),a(o,Z),N(o);let k=w("{","}",K.rest),ne=W(k.content,t).syntaxTreeRoot.nodes;a(o,ne),o.current=j,r=k.rest}else{let j=new v(x,O);a(o,j),a(o,Z),o.current=j,r=K.rest}m=!0;break}else break}if(m)continue;a(o,new T(u)),r=r.slice(u.length)}else a(o,new T("\\"+r[1])),r=r.slice(2);continue}if(r.startsWith("_{")){let s="_{",d=w(s,"}",r);if(d.rest.startsWith("^{")){let p=new U(s,"}^{","}");a(o,p);let x=W(d.content,t).syntaxTreeRoot.nodes;a(o,x),N(o);let O=w("^{","}",d.rest),K=W(O.content,t).syntaxTreeRoot.nodes;a(o,K),o.current=p,r=O.rest;continue}}let S=[["^{",()=>new U("","^{","}")],["_{",()=>new H("","_{","}")]];for(let s of S){let u=s[0];if(r.startsWith(u)){let d=s[1]();F(o,d);let p=w(u,"}",r),x=W(p.content,t).syntaxTreeRoot.nodes;a(o,x),o.current=d,r=p.rest,m=!0;break}}m!=!0&&(a(o,new T(r[0])),r=r.slice(1))}return o}var Y=class{constructor(){this.activePlaceholderShape=String.raw`\blacksquare`;this.passivePlaceholderShape=String.raw`\square`;this.selectionHightlightStart=String.raw`\colorbox{#ADD8E6}{\(\displaystyle`;this.selectionHightlightEnd=String.raw`\)}`}get activePlaceholderLatex(){return this.activePlaceholderColor==null?this.activePlaceholderShape:String.raw`{\color{${this.activePlaceholderColor}}${this.activePlaceholderShape}}`}get passivePlaceholderLatex(){return this.passivePlaceholderColor==null?this.passivePlaceholderShape:String.raw`{\color{${this.passivePlaceholderColor}}${this.passivePlaceholderShape}}`}};export{U as AscendingBranchingNode,f as BranchingNode,z as DecimalSeparatorNode,H as DescendingBranchingNode,G as DigitNode,B as KeyboardMemory,Y as LatexConfiguration,V as LatexParserConfiguration,A as LeafNode,J as MatrixNode,c as Placeholder,I as RoundBracketsNode,v as StandardBranchingNode,T as StandardLeafNode,g as TreeNode,te as deleteLeft,X as deleteRight,de as deleteSelection,ge as enterSelectionMode,ie as getEditModeLatex,ce as getViewModeLatex,xe as inSelectionMode,a as insert,F as insertWithEncapsulateCurrent,pe as insertWithEncapsulateSelection,fe as insertWithEncapsulateSelectionAndPrevious,q as leaveSelectionMode,me as moveDown,ue as moveLeft,N as moveRight,he as moveUp,W as parseLatex,Pe as selectLeft,ye as selectRight};
