function oe(e,t){return e.syntaxTreeRoot.getLatex(e,t)}function b(e){return e.toLowerCase()!=e.toUpperCase()}function Z(e){if(e.length==0)return!1;if(b(e[e.length-1]))for(let t=e.length-2;t>=0;t--){let r=e[t];if(!b(r))return r=="\\"}return!1}function O(...e){let t="";for(let r=0;r<e.length;r++){let o=e[r];Z(t)&&b(o[0])&&(t+=" "),t+=o}return t}var s=class{constructor(){this.parentNode=null;this.nodes=[]}getLatex(t,r){let o=()=>O(...this.nodes.map(n=>n.getLatex(t,r)));return t.inclusiveSelectionLeftBorder===this?O(r.selectionHightlightStart,o()):this===t.current?this.nodes.length==0?r.activePlaceholderLatex:O(r.activePlaceholderLatex,o()):this.nodes.length==0?r.passivePlaceholderLatex:o()}};var S=class{constructor(){this.syntaxTreeRoot=new s;this.current=this.syntaxTreeRoot;this.selectionDiff=null;this.inclusiveSelectionRightBorder=null;this.inclusiveSelectionLeftBorder=null}};var ne=new S;function ie(e,t){return(e instanceof S?e.syntaxTreeRoot:e).getLatex(ne,t)}function k(e,t){let r=!1;for(let o=e.length-1;o>=0;o--){let n=e[o];if(!r){n===t&&(r=!0);continue}if(n.nodes.length>0)return n}return null}function v(e){return e.length==0?null:e[e.length-1]}function u(e,t){let r=e.indexOf(t);return r>0?e[r-1]:null}function L(e,t){let r=e.indexOf(t);e.splice(r,1)}var h=class{getLatex(t,r){let o=this.getLatexPart(t,r);return t.selectionDiff!=null&&t.selectionDiff!=0?(t.inclusiveSelectionLeftBorder===this&&(o=O(r.selectionHightlightStart,o)),t.inclusiveSelectionRightBorder===this&&(o=O(o,r.selectionHightlightEnd)),o):t.current===this?O(o,r.activePlaceholderLatex):o}};var m=class extends h{constructor(r){super();this.placeholders=r,this.placeholders.forEach(o=>{o.parentNode=this})}getMoveDownSuggestion(r){return null}getMoveUpSuggestion(r){return null}};function x(e){return e[e.length-1]}var D=class extends h{};var P=class extends D{};function G(e,t,r){for(let o=e-1;o>=0;o--){let n=t[o];if(n instanceof P)L(t,n),r.nodes.unshift(n),n.parentPlaceholder=r;else break}}function W(e){let t=e.parentNode,r=t.parentPlaceholder.nodes.indexOf(t);t.parentPlaceholder.nodes.splice(r,1,...e.nodes);for(let o of e.nodes)o.parentPlaceholder=t.parentPlaceholder}function ee(e){if(e.current instanceof s){if(e.current.parentNode==null||e.current.nodes.length>0)return;{let t=k(e.current.parentNode.placeholders,e.current);if(t)e.current.parentNode.placeholders.length==2&&e.current===e.current.parentNode.placeholders[1]&&e.current.nodes.length==0?(W(t),e.current=x(t.nodes)):(t.nodes.pop(),e.current=v(t.nodes)??t);else if(e.current.parentNode.placeholders.every(r=>r.nodes.length==0)){let r=e.current.parentNode.parentPlaceholder,o=u(r.nodes,e.current.parentNode);L(r.nodes,e.current.parentNode),e.current=o??r}else if(e.current.parentNode.placeholders[0]===e.current&&e.current.nodes.length==0&&e.current.parentNode.placeholders.some(r=>r.nodes.length!=0)){let r=u(e.current.parentNode.parentPlaceholder.nodes,e.current.parentNode);if(r!=null)le(r,e.current),e.current=x(e.current.nodes);else{let o=e.current.parentNode.placeholders.filter(n=>n.nodes.length!=0);if(o.length==1){let n=o[0].nodes,c=e.current.parentNode.parentPlaceholder,p=c.nodes.indexOf(e.current.parentNode);for(let l of n)l.parentPlaceholder=c;c.nodes.splice(p,1,...n),e.current=x(n)}}}}}else if(e.current instanceof m&&e.current.placeholders[0].nodes.length>0&&e.current.placeholders.slice(1).every(t=>t.nodes.length==0)){let t=e.current.placeholders[0];W(t),e.current=x(t.nodes)}else if(e.current instanceof m&&e.current.placeholders.some(t=>t.nodes.length>0))e.current=x(e.current.placeholders.flatMap(t=>t.nodes)),ee(e);else{let t=u(e.current.parentPlaceholder.nodes,e.current);L(e.current.parentPlaceholder.nodes,e.current),e.current=t??e.current.parentPlaceholder}}function le(e,t){L(t.parentNode.parentPlaceholder.nodes,e),t.nodes.push(e);let r=e.parentPlaceholder;e.parentPlaceholder=t,e instanceof P&&G(r.nodes.length-1,r.nodes,t)}function K(e,t){let r=e.indexOf(t);return r!=-1&&r<e.length-1?e[r+1]:null}function J(e){if(e.current instanceof s)if(e.current.parentNode!=null&&e.current.parentNode.placeholders.every(t=>t.nodes.length==0)){let t=u(e.current.parentNode.parentPlaceholder.nodes,e.current.parentNode);L(e.current.parentNode.parentPlaceholder.nodes,e.current.parentNode),e.current=t??e.current.parentNode.parentPlaceholder}else{let t=e.current.nodes;if(t.length>0)re(e,t[0]);else if(e.current.parentNode!=null){let r=e.current.parentNode,o=r.placeholders;if(o[0]==e.current&&o.length==2){let n=o[1];e.current=u(r.parentPlaceholder.nodes,r)??r.parentPlaceholder,W(n)}else for(let n=o.indexOf(e.current)+1;n<o.length;n++)if(o[n].nodes.length>0){e.current=o[n],J(e);return}}}else{let t=K(e.current.parentPlaceholder.nodes,e.current);t!=null&&re(e,t)}}function re(e,t){t instanceof m?t.placeholders.length==1&&t.placeholders[0].nodes.length>0?W(t.placeholders[0]):t.placeholders.length==2&&t.placeholders[0].nodes.length==0&&t.placeholders[1].nodes.length>0?W(t.placeholders[1]):(e.current=t.placeholders[0],J(e)):L(t.parentPlaceholder.nodes,t)}function H(e){e.selectionDiff=null,e.inclusiveSelectionRightBorder=null,e.inclusiveSelectionLeftBorder=null}function E(e){if(e.selectionDiff==null)throw"Enter selection mode before calling this method.";if(e.selectionDiff==0)return H(e),[];let t=e.selectionDiff;if(e.current instanceof s)return H(e),e.current.nodes.splice(0,t);{let r=e.current.parentPlaceholder.nodes,o=r.indexOf(e.inclusiveSelectionLeftBorder);return e.current=u(r,e.inclusiveSelectionLeftBorder)??e.current.parentPlaceholder,H(e),r.splice(o,ce(t))}}function ce(e){return e<0?-e:e}function se(e){E(e)}function N(e){if(e.current instanceof s)if(e.current.nodes.length>0){let t=e.current.nodes[0];e.current=t instanceof m?t.placeholders[0]:t}else{if(e.current.parentNode==null)return;e.current=K(e.current.parentNode.placeholders,e.current)??e.current.parentNode}else{let t=K(e.current.parentPlaceholder.nodes,e.current);if(t!=null)e.current=t instanceof m?t.placeholders[0]:t;else{let r=e.current.parentPlaceholder.parentNode;if(r!=null){let o=K(r.placeholders,e.current.parentPlaceholder);e.current=o??r}}}}function a(e,t){if(t instanceof Array)for(let r of t)a(e,r),e.current=r;else{if(e.current instanceof s)e.current.nodes.unshift(t),t.parentPlaceholder=e.current;else{let r=e.current.parentPlaceholder,o=r.nodes.indexOf(e.current);r.nodes.splice(o+1,0,t),t.parentPlaceholder=r}N(e)}}var y=class extends m{constructor(r,o,...n){let c=n.length+1,p=new Array;for(let l=0;l<c;l++)p.push(new s);super(p);this.before=r,this.then=o,this.rest=n}getLatexPart(r,o){let n=this.before+this.placeholders[0].getLatex(r,o)+this.then;for(let c=0;c<this.rest.length;c++)n+=this.placeholders[c+1].getLatex(r,o)+this.rest[c];return n}};var A=class extends y{constructor(t=String.raw`\left(`,r=String.raw`\right)`){super(t,r)}};function I(e,t){for(let r of e)r.parentPlaceholder=t,t.nodes.push(r)}function j(e,t,r){let o=t.placeholders[0];if(e.current instanceof h){let n=e.current.parentPlaceholder.nodes,c=n.indexOf(e.current);n[c]=t,t.parentPlaceholder=e.current.parentPlaceholder,e.current instanceof A&&r?.deleteOuterRoundBracketsIfAny?(I(e.current.placeholders[0].nodes,o),e.current=K(t.placeholders,o)??t):e.current instanceof P?(o.nodes.push(e.current),e.current.parentPlaceholder=o,G(c,n,o),N(e)):(o.nodes.push(e.current),e.current.parentPlaceholder=o,N(e))}else a(e,t)}function ae(e,t){let r=E(e);if(a(e,t),r.length>0){let o=t.placeholders[0];I(r,o),e.current=x(r),N(e)}}function de(e,t){if(t.placeholders.length<2)throw"Expected 2 placeholders.";let r=E(e),o=t.placeholders[1];I(r,o),j(e,t),e.current=v(r)??o}function pe(e){let t=e.current instanceof s?e.current:e.current.parentPlaceholder,r;for(;;){if(t.parentNode==null)return;r=t.parentNode;let o=r.getMoveDownSuggestion(t);if(o!=null){e.current=v(o.nodes)??o;return}t=r.parentPlaceholder}}function fe(e){if(e.current instanceof s){if(e.current.parentNode==null)return;let t=u(e.current.parentNode.placeholders,e.current);if(t!==null)e.current=v(t.nodes)??t;else{let r=e.current.parentNode.parentPlaceholder,o=u(r.nodes,e.current.parentNode);e.current=o??r}}else if(e.current instanceof m){let t=x(e.current.placeholders);e.current=v(t.nodes)??t}else e.current=u(e.current.parentPlaceholder.nodes,e.current)??e.current.parentPlaceholder}function me(e){let t=e.current instanceof s?e.current:e.current.parentPlaceholder,r;for(;;){if(t.parentNode==null)return;r=t.parentNode;let o=r.getMoveUpSuggestion(t);if(o!=null){e.current=v(o.nodes)??o;return}t=r.parentPlaceholder}}function R(e,t){if(e.selectionDiff=t,t==0)e.inclusiveSelectionLeftBorder=null,e.inclusiveSelectionRightBorder=null;else if(e.current instanceof s)e.inclusiveSelectionLeftBorder=e.current,e.inclusiveSelectionRightBorder=e.current.nodes[t-1];else{let r=e.current.parentPlaceholder.nodes,o=r.indexOf(e.current);if(t>0)e.inclusiveSelectionLeftBorder=r[o+1],e.inclusiveSelectionRightBorder=r[o+t];else{let n=o+t+1;if(n<0)throw"The TreeNode at index 0 of the current Placeholder is as far as you can go left if current is a TreeNode.";e.inclusiveSelectionLeftBorder=r[n],e.inclusiveSelectionRightBorder=e.current}}}function ue(e){R(e,0)}function he(e){return e.selectionDiff!=null}function ge(e){let t=e.selectionDiff??0;e.current instanceof h&&e.current.parentPlaceholder.nodes.indexOf(e.current)+t>=0||e.current instanceof s&&t>0?R(e,t-1):e.inclusiveSelectionLeftBorder instanceof h&&e.inclusiveSelectionLeftBorder.parentPlaceholder.nodes.indexOf(e.inclusiveSelectionLeftBorder)==0&&e.inclusiveSelectionLeftBorder.parentPlaceholder.parentNode!=null&&(e.current=e.inclusiveSelectionLeftBorder.parentPlaceholder.parentNode,R(e,-1))}function xe(e){let t=e.selectionDiff??0;if(e.current instanceof s&&t<e.current.nodes.length||e.current instanceof h&&e.current.parentPlaceholder.nodes.indexOf(e.current)+t<e.current.parentPlaceholder.nodes.length-1)R(e,t+1);else if(e.inclusiveSelectionRightBorder instanceof h&&x(e.inclusiveSelectionRightBorder.parentPlaceholder.nodes)==e.inclusiveSelectionRightBorder&&e.inclusiveSelectionRightBorder.parentPlaceholder.parentNode!=null){let r=e.inclusiveSelectionRightBorder.parentPlaceholder.parentNode;e.current=u(r.parentPlaceholder.nodes,r)??r.parentPlaceholder,R(e,1)}}var q=class{constructor(){this.additionalDigits=null;this.decimalSeparatorMatchers=[".","{,}"];this.preferRoundBracketsNode=!0}};var _=class extends y{getMoveDownSuggestion(t){let r=this.placeholders.indexOf(t);return r>0?this.placeholders[r-1]:null}getMoveUpSuggestion(t){let r=this.placeholders.indexOf(t);return r<this.placeholders.length-1?this.placeholders[r+1]:null}};var F=class extends P{constructor(r="."){super();this.latex=typeof r=="string"?()=>r:r}getLatexPart(r,o){return this.latex()}};var $=class extends y{getMoveDownSuggestion(t){let r=this.placeholders.indexOf(t);return r<this.placeholders.length-1?this.placeholders[r+1]:null}getMoveUpSuggestion(t){let r=this.placeholders.indexOf(t);return r>0?this.placeholders[r-1]:null}};var V=class extends P{constructor(r){super();this.latex=r}getLatexPart(r,o){return this.latex}};var B=class extends D{constructor(r){super();this.latex=typeof r=="string"?()=>r:r}getLatexPart(r,o){return this.latex()}};function M(e,t,r){let o=e.slice(-1),n=r.slice(e.length),c=0;for(let p=0;p<n.length;p++){if(n.substring(p,p+t.length)==t){if(c==0)return{content:n.slice(0,p),rest:n.slice(p+t.length)};c--;continue}let l=["\\"+o,"\\"+t,String.raw`\left`+o,String.raw`\right`+t],f=n.slice(p);for(let i of l)if(f.length>=i.length&&f.startsWith(i)){p+=i.length;continue}n[p]==o&&c++}throw`A closing ${t} is missing.`}var z=class extends m{constructor(r,o,n){let c=[],p=[];for(let l=0;l<n;l++){let f=[];for(let i=0;i<o;i++){let d=new s;f.push(d),p.push(d)}c.push(f)}super(p);this.grid=c,this.matrixType=r,this.width=o}getLatexPart(r,o){let n=String.raw`\begin{${this.matrixType}}`;return n+=this.grid.map(c=>c.map(p=>p.getLatex(r,o)).join(" & ")).join(String.raw` \\ `),n+=String.raw`\end{${this.matrixType}}`,n}getMoveDownSuggestion(r){let{rowIndex:o,columnIndex:n}=this.getPositionOf(r);return o+1<this.grid.length?this.grid[o+1][n]:null}getMoveUpSuggestion(r){let{rowIndex:o,columnIndex:n}=this.getPositionOf(r);return o-1>=0?this.grid[o-1][n]:null}getPositionOf(r){let o=this.placeholders.indexOf(r);if(o==-1)throw"The provided Placeholder is not part of this MatrixNode.";let n=Math.floor(o/this.width),c=o-n*this.width;return{rowIndex:n,columnIndex:c}}};function C(e,t=new q){if(e==null)return new S;let r=e.trim(),o=new S;for(;r!="";){if(r[0]==" "){r=r.trimStart();continue}let n=t.decimalSeparatorMatchers.find(l=>r.startsWith(l));if(n!=null){a(o,new F(t.preferredDecimalSeparator??n)),r=r.slice(n.length);continue}if(["1","2","3","4","5","6","7","8","9","0"].includes(r[0])||t.additionalDigits?.includes(r[0])){a(o,new V(r[0])),r=r.slice(1);continue}let c=!1;if(r.startsWith(String.raw`\begin{`)){let l=M(String.raw`\begin{`,"}",r);if(!l.content.endsWith("matrix")&&!l.content.endsWith("cases"))throw String.raw`Expected a word ending with 'matrix' or 'cases' after '\begin{'.`;let i=l.rest.slice(0,l.rest.indexOf(String.raw`\end{${l.content}}`)).split(String.raw`\\`);a(o,new z(l.content,i[0].split("&").length,i.length));for(let g of i)for(let T of g.split("&")){let w=C(T,t).syntaxTreeRoot.nodes;a(o,w),N(o)}let d=String.raw`\end{${l.content}}`;r=r.slice(r.indexOf(d)+d.length);continue}if(t.preferRoundBracketsNode&&(r[0]=="("||r.startsWith(String.raw`\left(`))){let l=r[0]=="("?"(":String.raw`\left(`,f=r[0]=="("?")":String.raw`\right)`,i=new A(l,f);a(o,i);let d=M(l,f,r),g=C(d.content,t).syntaxTreeRoot.nodes;a(o,g),o.current=i,r=d.rest;continue}if(r.startsWith("\\")){for(let i of["\\left\\","\\right\\",String.raw`\left`,String.raw`\right`])if(r.startsWith(i)&&!b(r.slice(i.length)[0])){a(o,new B(i+r[i.length])),r=r.slice(i.length+1),c=!0;break}if(c)continue;let l=String.raw`\text{`;if(r.startsWith(l)){let i=M(l,"}",r),d=new y(l,"}");a(o,d);for(let g of i.content)a(o,new B(g));o.current=d,r=i.rest;continue}let f="\\";if(b(r[1])){for(let i=1;i<r.length;i++){let d=r[i];if(b(d))f+=d;else if(d=="{"||d=="["){let g=f+d,T=d=="{"?"}":"]",w=M(g,T,r),X=C(w.content,t).syntaxTreeRoot.nodes;if(w.rest[0]=="{"){let U=new $(g,T+"{","}");a(o,U),a(o,X),N(o);let Y=M("{","}",w.rest),te=C(Y.content,t).syntaxTreeRoot.nodes;a(o,te),o.current=U,r=Y.rest}else{let U=new y(g,T);a(o,U),a(o,X),o.current=U,r=w.rest}c=!0;break}else break}if(c)continue;a(o,new B(f)),r=r.slice(f.length)}else a(o,new B("\\"+r[1])),r=r.slice(2);continue}if(r.startsWith("_{")){let l="_{",i=M(l,"}",r);if(i.rest.startsWith("^{")){let d=new _(l,"}^{","}");a(o,d);let g=C(i.content,t).syntaxTreeRoot.nodes;a(o,g),N(o);let T=M("^{","}",i.rest),w=C(T.content,t).syntaxTreeRoot.nodes;a(o,w),o.current=d,r=T.rest;continue}}let p=[["^{",()=>new _("","^{","}")],["_{",()=>new $("","_{","}")]];for(let l of p){let f=l[0];if(r.startsWith(f)){let i=l[1]();j(o,i);let d=M(f,"}",r),g=C(d.content,t).syntaxTreeRoot.nodes;a(o,g),o.current=i,r=d.rest,c=!0;break}}c!=!0&&(a(o,new B(r[0])),r=r.slice(1))}return o}var Q=class{constructor(){this.activePlaceholderShape=String.raw`\blacksquare`;this.passivePlaceholderShape=String.raw`\square`;this.selectionHightlightStart=String.raw`\colorbox{#ADD8E6}{\(\displaystyle`;this.selectionHightlightEnd=String.raw`\)}`}get activePlaceholderLatex(){return this.activePlaceholderColor==null?this.activePlaceholderShape:String.raw`{\color{${this.activePlaceholderColor}}${this.activePlaceholderShape}}`}get passivePlaceholderLatex(){return this.passivePlaceholderColor==null?this.passivePlaceholderShape:String.raw`{\color{${this.passivePlaceholderColor}}${this.passivePlaceholderShape}}`}};export{_ as AscendingBranchingNode,m as BranchingNode,F as DecimalSeparatorNode,$ as DescendingBranchingNode,V as DigitNode,S as KeyboardMemory,Q as LatexConfiguration,q as LatexParserConfiguration,D as LeafNode,z as MatrixNode,s as Placeholder,A as RoundBracketsNode,y as StandardBranchingNode,B as StandardLeafNode,h as TreeNode,ee as deleteLeft,J as deleteRight,se as deleteSelection,ue as enterSelectionMode,oe as getEditModeLatex,ie as getViewModeLatex,he as inSelectionMode,a as insert,j as insertWithEncapsulateCurrent,ae as insertWithEncapsulateSelection,de as insertWithEncapsulateSelectionAndPrevious,H as leaveSelectionMode,pe as moveDown,fe as moveLeft,N as moveRight,me as moveUp,C as parseLatex,ge as selectLeft,xe as selectRight};
